{"version":3,"sources":["../../src/commands/develop-process.ts"],"names":["tracer","setTimeout","process","send","setInterval","type","telemetry","trackCli","on","msg","action","exit","payload","module","exports","program","bootstrapSpan","startSpan","env","GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES","report","panic","chalk","yellow","cyan","openTracingConfigFile","pendingActivity","id","startBackgroundUpdate","port","parseInt","e","message","app","developConfig","initial","states","initializing","invoke","src","onDone","target","actions","initializingDataLayer","data","parentSpan","store","firstRun","doingEverythingElse","gatsbyNodeGraphQLFunction","graphqlRunner","workerPool","finish","queryIds","boundActionCreators","setProgramStatus","ProgramStatus","BOOTSTRAP_QUERY_RUNNING_FINISHED","db","saveState","requiresWriter","startListener","startAutosave","queryUtil","startListeningToDevelopQueue","graphqlTracing","queryWatcher","startWatchDeletePage","service","services","initializeDataLayer","dataLayerMachine","initialize","assignStoreAndWorkerPool","_context","event","assignDataLayer","_","withContext","onTransition","state","reporter","verbose","JSON","stringify","value","start"],"mappings":"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","sourcesContent":["import { syncStaticDir } from \"../utils/get-static-dir\"\nimport report from \"gatsby-cli/lib/reporter\"\nimport chalk from \"chalk\"\nimport telemetry from \"gatsby-telemetry\"\nimport express from \"express\"\nimport { bootstrapSchemaHotReloader } from \"../bootstrap/schema-hot-reloader\"\nimport bootstrapPageHotReloader from \"../bootstrap/page-hot-reloader\"\nimport { initTracer } from \"../utils/tracer\"\nimport db from \"../db\"\nimport { detectPortInUseAndPrompt } from \"../utils/detect-port-in-use-and-prompt\"\nimport onExit from \"signal-exit\"\nimport queryUtil from \"../query\"\nimport queryWatcher from \"../query/query-watcher\"\nimport * as requiresWriter from \"../bootstrap/requires-writer\"\nimport { waitUntilAllJobsComplete } from \"../utils/wait-until-jobs-complete\"\nimport {\n  userPassesFeedbackRequestHeuristic,\n  showFeedbackRequest,\n} from \"../utils/feedback\"\nimport { startRedirectListener } from \"../bootstrap/redirects-writer\"\nimport { markWebpackStatusAsPending } from \"../utils/webpack-status\"\n\nimport { IProgram } from \"./types\"\nimport {\n  calculateDirtyQueries,\n  runStaticQueries,\n  runPageQueries,\n  startWebpackServer,\n  writeOutRequires,\n  IBuildContext,\n  initialize,\n  postBootstrap,\n  extractQueries,\n  rebuildSchemaWithSitePage,\n  writeOutRedirects,\n} from \"../services\"\nimport { boundActionCreators } from \"../redux/actions\"\nimport { ProgramStatus } from \"../redux/types\"\nimport {\n  MachineConfig,\n  AnyEventObject,\n  assign,\n  Machine,\n  DoneEventObject,\n  interpret,\n} from \"xstate\"\nimport { DataLayerResult, dataLayerMachine } from \"../state-machines/data-layer\"\nimport { IDataLayerContext } from \"../state-machines/data-layer/types\"\nimport { globalTracer } from \"opentracing\"\nimport reporter from \"gatsby-cli/lib/reporter\"\n\nconst tracer = globalTracer()\n\n// const isInteractive = process.stdout.isTTY\n\n// Watch the static directory and copy files to public as they're added or\n// changed. Wait 10 seconds so copying doesn't interfere with the regular\n// bootstrap.\nsetTimeout(() => {\n  syncStaticDir()\n}, 10000)\n\n// Time for another story...\n// When the parent process is killed by SIGKILL, Node doesm't kill spawned child processes\n// Hence, we peiodically send a heart beat to the parent to check if it is still alive\n// This will crash with Error [ERR_IPC_CHANNEL_CLOSED]: Channel closed\n// and kill the orphaned child process as a result\nif (process.send) {\n  setInterval(() => {\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n    process.send!({\n      type: `HEARTBEAT`,\n    })\n  }, 1000)\n}\n\nonExit(() => {\n  telemetry.trackCli(`DEVELOP_STOP`)\n})\n\nprocess.on(`message`, msg => {\n  if (msg.type === `COMMAND` && msg.action.type === `EXIT`) {\n    process.exit(msg.action.payload)\n  }\n})\n\nmodule.exports = async (program: IProgram): Promise<void> => {\n  const bootstrapSpan = tracer.startSpan(`bootstrap`)\n\n  // We want to prompt the feedback request when users quit develop\n  // assuming they pass the heuristic check to know they are a user\n  // we want to request feedback from, and we're not annoying them.\n  process.on(\n    `SIGINT`,\n    async (): Promise<void> => {\n      if (await userPassesFeedbackRequestHeuristic()) {\n        showFeedbackRequest()\n      }\n      process.exit(0)\n    }\n  )\n\n  if (process.env.GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES) {\n    report.panic(\n      `The flag ${chalk.yellow(\n        `GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES`\n      )} is not available with ${chalk.cyan(\n        `gatsby develop`\n      )}, please retry using ${chalk.cyan(`gatsby build`)}`\n    )\n  }\n  initTracer(program.openTracingConfigFile)\n  markWebpackStatusAsPending()\n  report.pendingActivity({ id: `webpack-develop` })\n  telemetry.trackCli(`DEVELOP_START`)\n  telemetry.startBackgroundUpdate()\n\n  const port =\n    typeof program.port === `string` ? parseInt(program.port, 10) : program.port\n\n  try {\n    program.port = await detectPortInUseAndPrompt(port)\n  } catch (e) {\n    if (e.message === `USER_REJECTED`) {\n      process.exit(0)\n    }\n\n    throw e\n  }\n\n  const app = express()\n\n  const developConfig: MachineConfig<IBuildContext, any, AnyEventObject> = {\n    id: `build`,\n    initial: `initializing`,\n    states: {\n      initializing: {\n        invoke: {\n          src: `initialize`,\n          onDone: {\n            target: `initializingDataLayer`,\n            actions: `assignStoreAndWorkerPool`,\n          },\n        },\n      },\n      initializingDataLayer: {\n        invoke: {\n          src: `initializeDataLayer`,\n          data: ({ parentSpan, store }: IBuildContext): IDataLayerContext => {\n            return { parentSpan, store, firstRun: true }\n          },\n          onDone: {\n            actions: `assignDataLayer`,\n            target: `doingEverythingElse`,\n          },\n        },\n      },\n      doingEverythingElse: {\n        invoke: {\n          src: async ({\n            gatsbyNodeGraphQLFunction,\n            graphqlRunner,\n            workerPool,\n            store,\n            app,\n          }): Promise<void> => {\n            // All the stuff that's not in the state machine yet\n\n            // These were previously in `bootstrap()` but are now\n            // in part of the state machine that hasn't been added yet\n            await rebuildSchemaWithSitePage({ parentSpan: bootstrapSpan })\n\n            await extractQueries({ parentSpan: bootstrapSpan })\n            await writeOutRedirects({ parentSpan: bootstrapSpan })\n\n            startRedirectListener()\n            bootstrapSpan.finish()\n            await postBootstrap({ parentSpan: bootstrapSpan })\n\n            // These are the parts that weren't in bootstrap\n\n            // Start the createPages hot reloader.\n            bootstrapPageHotReloader(gatsbyNodeGraphQLFunction)\n\n            // Start the schema hot reloader.\n            bootstrapSchemaHotReloader()\n\n            const { queryIds } = await calculateDirtyQueries({ store })\n\n            await runStaticQueries({ queryIds, store, program, graphqlRunner })\n            await runPageQueries({ queryIds, store, program, graphqlRunner })\n            await writeOutRequires({ store })\n            boundActionCreators.setProgramStatus(\n              ProgramStatus.BOOTSTRAP_QUERY_RUNNING_FINISHED\n            )\n\n            await db.saveState()\n\n            await waitUntilAllJobsComplete()\n            requiresWriter.startListener()\n            db.startAutosave()\n            queryUtil.startListeningToDevelopQueue({\n              graphqlTracing: program.graphqlTracing,\n            })\n            queryWatcher.startWatchDeletePage()\n\n            await startWebpackServer({ program, app, workerPool })\n          },\n        },\n      },\n    },\n  }\n\n  const service = interpret(\n    // eslint-disable-next-line new-cap\n    Machine(developConfig, {\n      services: {\n        initializeDataLayer: dataLayerMachine,\n        initialize,\n      },\n      actions: {\n        assignStoreAndWorkerPool: assign<IBuildContext, DoneEventObject>(\n          (_context, event) => {\n            const { store, workerPool } = event.data\n            return {\n              store,\n              workerPool,\n            }\n          }\n        ),\n        assignDataLayer: assign<IBuildContext, DoneEventObject>(\n          (_, { data }): DataLayerResult => data\n        ),\n      },\n    }).withContext({ program, parentSpan: bootstrapSpan, app })\n  )\n  service.onTransition(state => {\n    reporter.verbose(`transition to ${JSON.stringify(state.value)}`)\n  })\n  service.start()\n}\n"],"file":"develop-process.js"}